{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>üéØ AI ÎßûÏ∂§ Ï∂îÏ≤ú</h1>
    <p style="color: #888; font-size: 0.9rem; margin-top: 5px;">
        {% if keywords %}
        <span style="color: #1565C0;">{{ keywords | join(', ') }}</span> ÌÇ§ÏõåÎìú Í∏∞Î∞ò Ï∂îÏ≤ú
        {% else %}
        ÏÇ¨Ïö©ÏûêÏùò ÌéòÎ•¥ÏÜåÎÇòÏôÄ ÏµúÍ∑º Í¥ÄÏã¨ÏÇ¨Î•º Î∂ÑÏÑùÌïòÏó¨ ÏÑ†Î≥ÑÌïú Îâ¥Ïä§ÏûÖÎãàÎã§.
        {% endif %}
    </p>
</div>

{% if not recommendations %}
<div class="empty-state">
    <p>Ï∂îÏ≤ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÏùÑ Ïã§ÌñâÌï¥ Ï£ºÏÑ∏Ïöî.</p>
</div>
{% else %}
<div class="rec-grid">
    {% for rec in recommendations[:20] %}
    {% set idx = loop.index0 %}
    <div class="rec-card" id="rec-{{ idx }}" data-rec-id="{{ rec.id }}" data-idx="{{ idx }}">
        <div class="rec-meta">
            <span class="rec-score">Score: {{ "%.2f"|format(rec.score) }}</span>
            <span class="rec-media">{{ rec.media }}</span>
            {% if rec.date %}
            <span class="rec-date">{{ rec.date }}</span>
            {% endif %}
        </div>
        <a href="{{ rec.id }}" target="_blank" class="rec-title">{{ rec.title }}</a>
        <p class="rec-summary">{{ rec.summary[:150] if rec.summary else '' }}...</p>
        <div class="rec-footer">
            <div class="rating-section" id="rating-{{ idx }}">
                <button class="rate-btn" onclick="toggleRating({{ idx }})">ÌèâÍ∞Ä ‚≠ê</button>
            </div>
            <div class="rating-select" id="select-{{ idx }}" style="display: none;">
                <button class="score-num" onclick="submitRating({{ idx }}, '{{ rec.id }}', 1)">1</button>
                <button class="score-num" onclick="submitRating({{ idx }}, '{{ rec.id }}', 2)">2</button>
                <button class="score-num" onclick="submitRating({{ idx }}, '{{ rec.id }}', 3)">3</button>
                <button class="score-num" onclick="submitRating({{ idx }}, '{{ rec.id }}', 4)">4</button>
                <button class="score-num" onclick="submitRating({{ idx }}, '{{ rec.id }}', 5)">5</button>
            </div>
            <div class="rating-done" id="done-{{ idx }}" style="display: none;">
                <span class="done-badge">‚úì ÌèâÍ∞ÄÏôÑÎ£å</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Check localStorage for previously rated items
    document.addEventListener('DOMContentLoaded', function () {
        const ratedItems = JSON.parse(localStorage.getItem('ratedRecommendations') || '{}');

        document.querySelectorAll('.rec-card').forEach(card => {
            const recId = card.dataset.recId;
            const idx = card.dataset.idx;

            if (ratedItems[recId]) {
                // Already rated - show done state
                document.getElementById(`rating-${idx}`).style.display = 'none';
                document.getElementById(`select-${idx}`).style.display = 'none';
                document.getElementById(`done-${idx}`).style.display = 'flex';
            }
        });
    });

    function toggleRating(index) {
        document.getElementById(`rating-${index}`).style.display = 'none';
        document.getElementById(`select-${index}`).style.display = 'flex';
    }

    async function submitRating(index, recId, score) {
        // Save to localStorage
        const ratedItems = JSON.parse(localStorage.getItem('ratedRecommendations') || '{}');
        ratedItems[recId] = { score: score, timestamp: Date.now() };
        localStorage.setItem('ratedRecommendations', JSON.stringify(ratedItems));

        // Update UI - show done state
        document.getElementById(`select-${index}`).style.display = 'none';
        document.getElementById(`done-${index}`).style.display = 'flex';

        // Log to server
        try {
            await postData('/api/log', {
                event: 'rate',
                target_id: recId,
                score: score,
                type: 'recommendation'
            });
        } catch (e) { console.error(e); }
    }
</script>

<style>
    .rec-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .rec-card {
        background: white;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease;
    }

    .rec-card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .rec-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .rec-score {
        font-size: 0.75rem;
        color: #1565C0;
        background: #E3F2FD;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 600;
    }

    .rec-media {
        font-size: 0.75rem;
        color: #666;
        background: #f5f5f5;
        padding: 3px 8px;
        border-radius: 4px;
    }

    .rec-date {
        font-size: 0.7rem;
        color: #999;
    }

    .rec-title {
        font-size: 1.05rem;
        font-weight: 600;
        color: #222;
        text-decoration: none;
        line-height: 1.4;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .rec-title:hover {
        color: #FF4B4B;
    }

    .rec-summary {
        font-size: 0.85rem;
        color: #666;
        line-height: 1.5;
        margin: 0 0 15px 0;
        flex-grow: 1;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .rec-footer {
        border-top: 1px solid #f5f5f5;
        padding-top: 12px;
        min-height: 40px;
    }

    .rate-btn {
        background: white;
        border: 1px solid #e0e0e0;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        color: #555;
        transition: all 0.2s;
    }

    .rate-btn:hover {
        background: #FFF8E1;
        border-color: #FFD54F;
        color: #F57F17;
    }

    .rating-select {
        display: flex;
        gap: 6px;
    }

    .score-num {
        flex: 1;
        min-width: 40px;
        min-height: 36px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        color: #555;
        transition: all 0.2s;
        position: relative;
        z-index: 10;
    }

    .score-num:hover {
        background: #FF4B4B;
        color: white;
        border-color: #FF4B4B;
    }

    .rating-done {
        display: flex;
        align-items: center;
    }

    .done-badge {
        background: #E8F5E9;
        color: #2E7D32;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
    }
</style>
{% endblock %}